# Silver Module 2: Email MCP Server + Approval Workflow

## Feature Overview

**Feature**: Silver Module 2: Email MCP Server + Approval Workflow
**Purpose**: Enable email sending with human-in-the-loop approvals
**Time Estimate**: 8-10 hours
**Dependencies**: Silver Module 1 complete

## Description

This module implements an MCP (Model Context Protocol) server for sending emails via Gmail API with a human-in-the-loop approval system. The system prevents unauthorized email sending by requiring human approval for all outbound emails generated by the AI Employee. The workflow involves creating approval requests in a Pending_Approval folder, which humans can review and move to Approved or Rejected folders for processing.

## User Scenarios & Testing

### Scenario 1: MCP Server Operation
**Actor**: Developer/System Administrator
**Trigger**: Starting the email MCP server
**Steps**:
1. User installs and configures the email MCP server
2. Server connects to Gmail API using stored credentials
3. MCP tools (send_email, draft_email) become available to Claude Code
4. Server validates approval file requirements before sending
5. All email actions are logged for audit purposes

**Success Criteria**: MCP server starts successfully and tools are accessible to Claude Code

### Scenario 2: Approval Workflow - Successful Send
**Actor**: AI Employee and Human User
**Trigger**: AI Employee needs to send an email reply
**Steps**:
1. AI Employee drafts email reply using SKILL_EmailProcessor
2. System creates approval request in /Pending_Approval/ folder
3. Human reviews and moves file to /Approved/ folder
4. Orchestrator detects approved file and calls MCP to send email
5. Email is sent, approval file moved to /Done/, and logged
6. Dashboard is updated with successful send

**Success Criteria**: Email sent within 1 minute of approval, all logging completed

### Scenario 3: Approval Workflow - Rejection
**Actor**: Human User
**Trigger**: Human decides not to send an email
**Steps**:
1. Human reviews approval request in /Pending_Approval/ folder
2. Human moves file to /Rejected/ folder with optional reason
3. Approval handler processes rejection
4. Rejection is logged in audit trail
5. Dashboard is updated with rejection status

**Success Criteria**: Rejection logged, no email sent, audit trail updated

## Functional Requirements

### FR-1: Email MCP Server
The system SHALL provide an MCP server for sending emails via Gmail API.
The system SHALL implement a send_email tool that accepts recipient, subject, body, and approval file parameters.
The system SHALL verify that the approval file exists in the /Approved/ folder before sending.
The system SHALL implement a draft_email tool for previewing without sending.
The system SHALL log all email actions to mcp_actions.log with timestamps and status.
The system SHALL handle errors gracefully and return appropriate error messages.
The system SHALL move approved files to /Done/ after successful sending.

### FR-2: MCP Integration
The system SHALL integrate with Claude Code via MCP protocol.
The system SHALL be configurable through mcp.json with proper paths and environment variables.
The system SHALL be accessible to Claude Code when the system is running.
The system SHALL validate all required parameters before attempting to send emails.

### FR-3: Approval Workflow Management
The system SHALL create approval request files in the /Pending_Approval/ folder when emails need sending.
The system SHALL follow a standardized format for approval request files with YAML frontmatter.
The system SHALL process files in the /Approved/ folder automatically when detected by orchestrator.
The system SHALL process files in the /Rejected/ folder and log rejections appropriately.
The system SHALL provide clear instructions to humans on how to approve or reject requests.

### FR-4: Approval Handler Skill
The system SHALL provide a SKILL_ApprovalHandler with clear instructions for processing approvals.
The system SHALL handle email_approval type requests by calling the MCP send_email tool.
The system SHALL handle rejected requests by logging them appropriately.
The system SHALL update the Dashboard with approval/rejection status.
The system SHALL implement retry logic for failed email sends (max 3 attempts).
The system SHALL handle malformed approval files by moving them to /Logs/malformed/ for review.

### FR-5: Enhanced Email Processing
The system SHALL update SKILL_EmailProcessor to generate approval requests for email replies.
The system SHALL draft professional email responses following Company_Handbook guidelines.
The system SHALL create proper approval file format with all required metadata.
The system SHALL identify when NOT to generate replies (automated notifications, spam, etc.).
The system SHALL link approval requests to original email files for context.

## Non-functional Requirements

### Security Requirements
- All email sends MUST require approval file validation
- MCP server MUST verify approval files are in /Approved/ folder
- Email addresses MUST be validated before sending
- All actions MUST be logged for audit trail

### Performance Requirements
- Email MCP server SHALL start within 10 seconds
- Approved emails SHALL be sent within 1 minute of file detection
- Approval handler SHALL process files within 30 seconds
- System SHALL support concurrent processing of multiple approvals

### Reliability Requirements
- System SHALL continue operating if individual email sends fail
- Retry mechanism SHALL handle temporary failures
- Error recovery SHALL be implemented for all failure scenarios
- Audit logs SHALL be preserved even during system failures

## Success Criteria

### Quantitative Measures
- 100% of email sends require approval validation
- 95% success rate for approved email deliveries
- Approval files processed within 1 minute of placement in /Approved/
- 0% unauthorized emails sent without approval
- All email actions logged with 100% accuracy

### Qualitative Measures
- Human reviewers can easily understand and process approval requests
- Email replies follow professional tone and Company_Handbook guidelines
- System operation is transparent with clear logging
- User experience is seamless with minimal manual intervention required

## Key Entities

### Approval Request
- Type: email_approval, linkedin_approval
- Status: awaiting_approval, approved, rejected
- Recipient: email address or platform identifier
- Content: email body or post content
- Metadata: original task reference, timestamp, priority

### MCP Server
- Tools: send_email, draft_email
- Configuration: credentials, environment variables
- Logging: mcp_actions.log entries

### Email Message
- To: recipient address
- Subject: email subject line
- Body: email content (HTML/plain text)
- CC: optional carbon copy recipients

## Assumptions

- Gmail API credentials are properly configured and stored securely
- Claude Code MCP integration is available and functional
- User has appropriate permissions to create and modify files in the vault directory
- Network connectivity is available for Gmail API communication
- Company Handbook provides adequate guidelines for email tone and content

## Constraints

- All email sends require human approval (no automatic sending)
- MCP server must use Gmail API for email delivery
- Approval workflow must follow file-based folder system
- Must integrate with existing orchestrator and skill system
- Audit logging must be maintained for compliance purposes